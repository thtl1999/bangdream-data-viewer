import os
import requests
import sys
import fileinput
import re
import json
import urllib.request

musicnamecode = '126'

#get bms file from bangdream database
if not os.path.isfile('scorebms/'+musicnamecode+'ex.txt'):
    print('download bms from bangdream database')
    req = requests.get('https://api.bangdream.ga/v1/jp/music/'+musicnamecode)
    data = req.json()
    musicnamestring = data["chartAssetBundleName"]
    req = requests.get('https://res.bangdream.ga/assets/musicscore/'+musicnamecode+'_'+musicnamestring+'_expert.txt')
    html = req.text
    f1 = open('scorebms/'+musicnamecode+'ex.txt','w')
    f1.write(html)
    f1.close()
else:
    print("alreay have music score")


#parse bms data
fr = open("scorebms/"+musicnamecode+'ex.txt','r')
fw = open("myscore/" + musicnamecode + ".txt", 'w')

se = {}
#header read
while True:
    line = fr.readline()
    #print(line)
    if line.find('MAIN') != -1:
        break
    if line.find('WAV') != -1:
        se[line[4:6]] = line[7:-1]
        #print(se[line[4:6]])
    elif line.find('BPM') != -1:
        bpm = float(line[5:-1])
    else:
        continue

print(se)
print('bpm:' + str(bpm))
#main read
note = []   #all the notes will be put here. note has notese, notetype, notebeat, notelane, noteproperty, notetiming
noteindex = 0   #to indicate note number
while True:
    line = fr.readline()
    if not line: break

    if line.find('#') == -1: #only read for #
        continue

    nowbeat = float(line[1:4])  #first 3 digit indicate beat
    lanestring = line[4:6]      #last 2 digit indicate lane number and type


    #select lane number
    if lanestring[1] == '6': lane = 1
    if lanestring[1] == '1': lane = 2
    if lanestring[1] == '2': lane = 3
    if lanestring[1] == '3': lane = 4
    if lanestring[1] == '4': lane = 5
    if lanestring[1] == '5': lane = 6
    if lanestring[1] == '8': lane = 7
    #select long note line
    if lanestring[0] == '1':
        isitlong = False
    if lanestring[0] == '5':
        isitlong = True
    # special lane number
    if lanestring == '01': lane = 0


    #read line
    beatnumber = 0  # to count how much digit are there. to calculate beat
    i = 7           # start string number of line
    thislinenoteindex = noteindex   # save current note index to check
    while (i+2) < len(line):
        if line[i:i+2] != '00':
            note.append({})
            note[noteindex] = {'notese': line[i:i+2]}
            note[noteindex]['notese'] = line[i:i+2]       # notetype is selected by se
            note[noteindex]['notebeat'] = beatnumber      # notebeat should be corrected after read all digit in this line
            note[noteindex]['notelane'] = lane
            noteindex += 1                              # if note exist, index++


        beatnumber += 1                                 # count beat
        i = i+2                                         # every note is 2 digit number(string)

    #calculate notebeat and select note type
    for i in range(thislinenoteindex , noteindex):
        tempbeat = nowbeat + 1/beatnumber*note[i]['notebeat']
        note[i]['notebeat'] = tempbeat
        print(str(nowbeat) + str(note[i]['notebeat']))
        note[i]['notetype'] = se[note[i]['notese']]


fr.close()
fw.close()


